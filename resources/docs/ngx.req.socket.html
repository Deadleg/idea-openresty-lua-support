<p><strong>syntax:</strong> <em>tcpsock, err = ngx.req.socket()</em></p><p><strong>syntax:</strong> <em>tcpsock, err = ngx.req.socket(raw)</em></p><p><strong>context:</strong> <em>rewrite_by_lua&#42;, access_by_lua&#42;, content_by_lua&#42;</em></p><p>Returns a read-only cosocket object that wraps the downstream connection. Only <a href="#tcpsockreceive">receive</a> and <a href="#tcpsockreceiveuntil">receiveuntil</a> methods are supported on this object.</p><p>In case of error, <code>nil</code> will be returned as well as a string describing the error.</p><p>The socket object returned by this method is usually used to read the current request's body in a streaming fashion. Do not turn on the <a href="#lua_need_request_body">lua_need_request_body</a> directive, and do not mix this call with <a href="#ngxreqread_body">ngx.req.read_body</a> and <a href="#ngxreqdiscard_body">ngx.req.discard_body</a>.</p><p>If any request body data has been pre-read into the Nginx core request header buffer, the resulting cosocket object will take care of this to avoid potential data loss resulting from such pre-reading. Chunked request bodies are not yet supported in this API.</p><p>Since the <code>v0.9.0</code> release, this function accepts an optional boolean <code>raw</code> argument. When this argument is <code>true</code>, this function returns a full-duplex cosocket object wrapping around the raw downstream connection socket, upon which you can call the <a href="#tcpsockreceive">receive</a>, <a href="#tcpsockreceiveuntil">receiveuntil</a>, and <a href="#tcpsocksend">send</a> methods.</p><p>When the <code>raw</code> argument is <code>true</code>, it is required that no pending data from any previous <a href="#ngxsay">ngx.say</a>, <a href="#ngxprint">ngx.print</a>, or <a href="#ngxsend_headers">ngx.send_headers</a> calls exists. So if you have these downstream output calls previously, you should call <a href="#ngxflush">ngx.flush(true)</a> before calling <code>ngx.req.socket(true)</code> to ensure that there is no pending output data. If the request body has not been read yet, then this "raw socket" can also be used to read the request body.</p><p>You can use the "raw request socket" returned by <code>ngx.req.socket(true)</code> to implement fancy protocols like <a href="http://en.wikipedia.org/wiki/WebSocket">WebSocket</a>, or just emit your own raw HTTP response header or body data. You can refer to the <a href="https://github.com/openresty/lua-resty-websocket">lua-resty-websocket library</a> for a real world example.</p><p>This function was first introduced in the <code>v0.5.0rc1</code> release.</p>